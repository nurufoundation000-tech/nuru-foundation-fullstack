<script src="scripts/auth.js"></script>
<script src="scripts/header.js"></script>
<script src="scripts/footer.js"></script>
<script>
    const API_BASE_URL = window.location.hostname === 'localhost' ? 'http://localhost:5000/api' : 'https://nuru-foundation-fullstack.vercel.app/api';
    let allCourses = [];
    let currentUnenrollId = null;

    document.addEventListener('DOMContentLoaded', function() {
        loadHeaderAndFooter();
        checkAuthAndLoadCourses();
        setupEventListeners();
    });

    function loadHeaderAndFooter() {
        // Load header
        fetch('header.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('header-placeholder').innerHTML = data;
                if (typeof initHeader === 'function') {
                    initHeader();
                }
            })
            .catch(error => console.error('Error loading header:', error));

        // Load footer
        fetch('footer.html')
            .then(response => response.text())
            .then(data => {
                document.getElementById('footer-placeholder').innerHTML = data;
                if (typeof startCourseRotation === 'function') {
                    startCourseRotation();
                }
            })
            .catch(error => console.error('Error loading footer:', error));
    }

    function checkAuthAndLoadCourses() {
        const token = localStorage.getItem('token');
        if (!token) {
            window.location.href = 'login.html';
            return;
        }

        loadCourses();
    }

    function setupEventListeners() {
        document.getElementById('statusFilter').addEventListener('change', filterAndDisplayCourses);
        document.getElementById('sortBy').addEventListener('change', filterAndDisplayCourses);
        document.getElementById('searchInput').addEventListener('input', filterAndDisplayCourses);
    }

    async function loadCourses() {
        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/courses/progress`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                if (response.status === 401) {
                    window.location.href = 'login.html';
                    return;
                }
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            allCourses = await response.json();
            updateStats();
            displayCourses(allCourses);
        } catch (error) {
            console.error('Error loading courses:', error);
            document.getElementById('coursesContent').innerHTML = `
                <div class="error">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error loading courses. Please try again later.
                </div>
            `;
        }
    }

    function updateStats() {
        const enrolledCount = allCourses.length;
        const completedCount = allCourses.filter(course => course.progress >= 100).length;
        const inProgressCount = allCourses.filter(course => course.progress > 0 && course.progress < 100).length;
        const avgProgress = enrolledCount > 0
            ? Math.round(allCourses.reduce((sum, course) => sum + course.progress, 0) / enrolledCount)
            : 0;

        document.getElementById('enrolledCount').textContent = enrolledCount;
        document.getElementById('completedCount').textContent = completedCount;
        document.getElementById('inProgressCount').textContent = inProgressCount;
        document.getElementById('totalProgress').textContent = `${avgProgress}%`;
    }

    function filterAndDisplayCourses() {
        const statusFilter = document.getElementById('statusFilter').value;
        const sortBy = document.getElementById('sortBy').value;
        const searchTerm = document.getElementById('searchInput').value.toLowerCase();

        let filteredCourses = [...allCourses];

        // Apply status filter
        switch (statusFilter) {
            case 'completed':
                filteredCourses = filteredCourses.filter(course => course.progress >= 100);
                break;
            case 'in-progress':
                filteredCourses = filteredCourses.filter(course => course.progress > 0 && course.progress < 100);
                break;
            case 'not-started':
                filteredCourses = filteredCourses.filter(course => course.progress === 0);
                break;
        }

        // Apply search filter
        if (searchTerm) {
            filteredCourses = filteredCourses.filter(course =>
                course.course.title.toLowerCase().includes(searchTerm) ||
                course.course.description?.toLowerCase().includes(searchTerm) ||
                course.course.tutor.username.toLowerCase().includes(searchTerm)
            );
        }

        // Apply sorting
        switch (sortBy) {
            case 'progress':
                filteredCourses.sort((a, b) => b.progress - a.progress);
                break;
            case 'title':
                filteredCourses.sort((a, b) => a.course.title.localeCompare(b.course.title));
                break;
            case 'recent':
            default:
                filteredCourses.sort((a, b) => new Date(b.enrolledAt) - new Date(a.enrolledAt));
                break;
        }

        displayCourses(filteredCourses);
    }

    function displayCourses(courses) {
        const container = document.getElementById('coursesContent');

        if (courses.length === 0) {
            container.innerHTML = `
                <div class="no-courses">
                    <i class="fas fa-book-open"></i>
                    <h3>No courses found</h3>
                    <p>${allCourses.length === 0 ? 'You haven\'t enrolled in any courses yet.' : 'No courses match your current filters.'}</p>
                    ${allCourses.length === 0 ? '<a href="courses.html" class="course-btn">Browse Courses</a>' : ''}
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="courses-grid">
                ${courses.map(enrollment => createCourseCard(enrollment)).join('')}
            </div>
        `;
    }

    function createCourseCard(enrollment) {
        const course = enrollment.course;
        const progressPercent = Math.round(enrollment.progress);
        const isCompleted = progressPercent >= 100;
        const status = isCompleted ? 'completed' : (progressPercent > 0 ? 'in-progress' : 'not-started');

        return `
            <div class="course-card" data-status="${status}">
                <div class="course-header">
                    <h3>${course.title}</h3>
                    <div class="course-tutor">
                        <i class="fas fa-user-graduate"></i> ${course.tutor.fullName || course.tutor.username}
                    </div>
                    <div class="course-category">${course.category || 'General'}</div>
                </div>

                <div class="course-content">
                    <div class="course-description">
                        ${course.description || 'No description available.'}
                    </div>

                    <div class="progress-section">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                        <div class="progress-text">
                            ${isCompleted ? 'Completed' : `${progressPercent}% Complete`}
                            (${enrollment.completedLessons}/${enrollment.totalLessons} lessons)
                        </div>
                    </div>

                    <div class="course-actions">
                        <button class="course-btn" onclick="continueCourse(${course.id})">
                            <i class="fas fa-play"></i> ${isCompleted ? 'Review' : 'Continue'}
                        </button>
                        <button class="course-btn secondary" onclick="viewCourseDetails(${course.id})">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        <button class="course-btn outline" onclick="showUnenrollModal(${enrollment.id})">
                            <i class="fas fa-sign-out-alt"></i> Unenroll
                        </button>
                    </div>
                </div>
            </div>
        `;
    }

    function continueCourse(courseId) {
        window.location.href = `lesson-viewer.html?courseId=${courseId}`;
    }

    function viewCourseDetails(courseId) {
        // For now, redirect to lesson viewer. Could be enhanced to show course details modal
        window.location.href = `lesson-viewer.html?courseId=${courseId}`;
    }

    function showUnenrollModal(enrollmentId) {
        currentUnenrollId = enrollmentId;
        document.getElementById('unenrollModal').classList.add('show');
    }

    function closeUnenrollModal() {
        document.getElementById('unenrollModal').classList.remove('show');
        currentUnenrollId = null;
    }

    async function confirmUnenroll() {
        if (!currentUnenrollId) return;

        try {
            const token = localStorage.getItem('token');
            const response = await fetch(`${API_BASE_URL}/courses/${currentUnenrollId}/unenroll`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }

            closeUnenrollModal();
            // Reload courses
            await loadCourses();
            alert('Successfully unenrolled from the course.');
        } catch (error) {
            console.error('Error unenrolling:', error);
            alert('Error unenrolling from course. Please try again.');
        }
    }

    // Close modal when clicking outside
    document.getElementById('unenrollModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeUnenrollModal();
        }
    });
</script>